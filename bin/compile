#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

pcre_url=https://s3-eu-west-1.amazonaws.com/midgard-heroku/pcre.tar.gz
gdbm_url=http://codefirst.org/mzp/gdbm-1.tgz
ocaml_url=http://codefirst.org/mzp/ocaml-4.00.tgz
opam_url=http://codefirst.org/mzp/opam-full-1.0.tgz
opam_lib_url=http://codefirst.org/mzp/opam-lib.tgz

BUILD_DIR=$1
CACHE_DIR=$2

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function setup() {
  dir=$1
  url=$2

  mkdir -p $dir
  echo "fetching $url to $dir"
  curl  $url -s -o - | tar xzvf - -C $dir
}

cd $BUILD_DIR

echo "-----> Fetching PCRE binaries"
setup /app $pcre_url  # /app/vendor/pcre

echo "-----> Fetching GDBM binaries"
setup /app/vendor/gdbm $gdbm_url  # /app/vendor/gdbm/

echo "-----> Fetching OCaml binaries"
setup /tmp/ocaml $ocaml_url # /tmp/ocaml

echo "-----> Fetching OCaml libraries"
setup /tmp/opam  $opam_url #/tmp/opam

echo "-----> Fetching OPAM libraries"
setup /tmp/opam-lib  $opam_lib_url #/tmp/opam-lib

echo "-----> Prepending $dir/bin to PATH"
export PATH="/app/vendor/pcre/bin:/app/vendor/gdbm/bin:/tmp/ocaml/bin:/tmp/opam/bin:$PATH"
export LD_PRELOAD=/app/vendor/pcre/lib/libpcre.so.1

echo "-----> Load OPAM"
source /tmp/opam-lib/opam-init/init.sh

# make
echo "-----> Compiling with Make"
make all 2>&1 | indent
